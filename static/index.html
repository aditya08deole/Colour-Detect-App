<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="An advanced color picker to detect and identify colors from any uploaded image with high perceptual accuracy, featuring advanced palettes and history.">
    
    <title>Color Picker Pro - Advanced Color Detector</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div class="app-container">
        <aside class="sidebar">
            <div>
                <h1 class="logo">Color<span>Picker</span> Pro</h1>
                <p>Perceptually accurate color detection.</p>
            </div>
            
            <div class="magnifier-container">
                <h2>Magnifier</h2>
                <div id="magnifier-canvas">
                    <div id="magnifier-crosshair"></div>
                </div>
            </div>

            <div class="results-container">
                <h2>Current Selection</h2>
                <div id="results-card" class="results-card">
                    <div class="results-header">
                        <div id="color-box"></div>
                        <div id="color-details">
                            <p><strong>Name:</strong> <span id="colorName">N/A</span></p>
                            <p><strong>Hex:</strong> <span id="hexCode">N/A</span> <button class="copy-btn" onclick="colorApp.copyToClipboard('#hexCode', this)">copy</button></p>
                            <p><strong>RGB:</strong> <span id="rgbValue">N/A</span> <button class="copy-btn" onclick="colorApp.copyToClipboard('#rgbValue', this)">copy</button></p>
                        </div>
                    </div>
                    <div class="palette-container">
                        <div class="palette-tabs">
                            <button class="palette-tab active" data-tab="shades_tints">Shades & Tints</button>
                            <button class="palette-tab" data-tab="complementary">Complementary</button>
                            <button class="palette-tab" data-tab="triadic">Triadic</button>
                        </div>
                        <div id="palette-content-shades_tints" class="palette-content active"></div>
                        <div id="palette-content-complementary" class="palette-content"></div>
                        <div id="palette-content-triadic" class="palette-content"></div>
                    </div>
                </div>
            </div>

            <div id="history-container">
                <div class="history-header">
                    <h2>History</h2>
                    <span id="clear-history">Clear</span>
                </div>
                <ul id="history-list">
                    <li id="history-empty-state" style="justify-content: center; opacity: 0.6;">No colors picked yet.</li>
                </ul>
            </div>
             <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-toggle">
                    <input type="checkbox" id="theme-toggle">
                    <div class="slider round"></div>
                </label>
                <em>Dark Mode</em>
            </div>
        </aside>

        <main class="main-content">
            <div class="canvas-wrapper">
                <div class="controls-header">
                    <label for="imageLoader" id="upload-label" class="upload-label">
                        <span id="upload-text">Upload New Image</span>
                    </label>
                    <div class="zoom-panel-pro" id="zoom-panel-pro">
                        <button id="zoom-out-btn-pro" title="Zoom Out" aria-label="Zoom Out"><svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                        <input type="range" id="zoom-slider-pro" min="10" max="3000" value="100" step="1" aria-label="Zoom slider">
                        <input type="number" id="zoom-input-pro" class="zoom-display" value="100" readonly>
                        <button id="zoom-in-btn-pro" title="Zoom In" aria-label="Zoom In"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                        <button id="fit-zoom-btn-pro" title="Fit to View" aria-label="Fit to View"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg></button>
                        <button class="pan-mode-btn" id="pan-mode-btn" title="Toggle Pan Mode" aria-label="Toggle Pan Mode"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 18.172a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-3.342a2 2 0 0 0-1.172-1.83l-5.25-3.03a2 2 0 0 0-2 0l-5.25 3.03A2 2 0 0 0 4 14.83v3.342z"/><path d="M10.001 5.172a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2h0a2 2 0 0 1-2-2v0z"/></svg></button>
                    </div>
                </div>
                <div class="canvas-container" id="canvas-container">
                    <div id="upload-area" class="upload-area">
                        <p>Drag & Drop Image Here or Click</p>
                        <input type="file" id="imageLoader" accept="image/png, image/jpeg, image/webp">
                    </div>
                    <canvas id="imageCanvas" tabindex="0"></canvas>
                    <canvas class="pixel-grid-canvas"></canvas> <button class="close-image-btn" id="close-image-btn" title="Close Image" aria-label="Close Image">&times;</button>
                    <div class="virtual-cursor"></div>
                    <div class="navigator"><div class="navigator-view"></div></div> <div class="loader-container"><div class="loader" style="width:50px; height:50px;"></div></div>
                    <div id="mobile-loupe"><div class="loupe-crosshair"></div></div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="toast-container"></div>
    <footer>
        &copy; <span id="copyright-year">2025</span> Made by Adi Deole &bull; <a href="https://github.com/your-repo" target="_blank" rel="noopener noreferrer">GitHub</a>
    </footer>

    <script>
        // UPGRADE: Modularize logic into separate objects for better architecture
        const UIManager = {
            // ... references to DOM elements
            init() { /* ... */ },
            showMainLoader() { /* ... */ },
            // ... all DOM update functions would go here
        };

        const StateManager = {
            // ... all state properties like currentImageFile, colorHistory, etc.
        };
        
        // For simplicity, we'll keep the single object but refactor it heavily.
        const colorApp = {
            // UPGRADE: Use constants for "magic numbers"
            CONSTANTS: {
                MAX_IMAGE_DIMENSION: 1920,
                MAGNIFIER_ZOOM: 8,
                HISTORY_LIMIT: 20,
                LOUPE_OFFSET_Y: 80,
                LOUPE_TAP_DELAY: 150,
            },

            // DOM Elements
            getDOMElements() {
                const elements = {};
                const ids = [
                    'upload-area', 'imageLoader', 'upload-label', 'upload-text',
                    'imageCanvas', 'canvas-container', 'loader-container', 
                    'results-card', 'color-box', 'colorName', 'hexCode', 'rgbValue', 
                    'history-container', 'history-list', 'history-empty-state', 'clear-history',
                    'magnifier-canvas', 'toast-container', 'theme-toggle', 'palette-container',
                    'mobile-loupe', 'pan-mode-btn', 'close-image-btn', 'copyright-year',
                    // New zoom panel
                    'zoom-slider-pro', 'zoom-input-pro', 'zoom-in-btn-pro', 'zoom-out-btn-pro', 'fit-zoom-btn-pro'
                ];
                ids.forEach(id => elements[id] = document.getElementById(id));
                
                // Class-based selectors
                elements.pixelGridCanvas = document.querySelector('.pixel-grid-canvas');
                elements.navigator = document.querySelector('.navigator');
                elements.navigatorView = document.querySelector('.navigator-view');
                elements.virtualCursor = document.querySelector('.virtual-cursor');
                elements.magnifierContainer = document.querySelector('.magnifier-container');
                elements.resultsContainer = document.querySelector('.results-container');
                
                elements.ctx = elements.imageCanvas.getContext('2d');
                elements.pixelGridCtx = elements.pixelGridCanvas.getContext('2d');
                return elements;
            },

            // State
            getInitialState() {
                return {
                    currentImageFile: null,
                    panzoomInstance: null,
                    originalImage: null,
                    colorHistory: [],
                    isPanning: false,
                    isPanMode: false,
                    lastPointerEvent: null,
                    isTransformDirty: false,
                    activeTouch: null, // will hold timeout ID
                    virtualCursorPos: { x: 0, y: 0 },
                };
            },

            init() {
                this.dom = this.getDOMElements();
                this.state = this.getInitialState();
                
                this.setupEventListeners();
                this.dom.copyrightYear.textContent = new Date().getFullYear();
                if (localStorage.getItem('theme') === 'dark') { this.dom.themeToggle.checked = true; document.body.classList.add('dark-mode'); }
            },

            // --- UPGRADE: Centralized Event Listener Setup ---
            setupEventListeners() {
                this.dom.imageLoader.addEventListener('change', (e) => this.handleFiles(e.target.files));
                this.setupDragAndDrop();
                this.setupZoomControls();
                this.dom.panModeBtn.addEventListener('click', () => this.togglePanMode());
                this.dom.closeImageBtn.addEventListener('click', () => this.resetState());
                
                this.dom.clearHistory.addEventListener('click', () => this.clearHistory());
                this.dom.themeToggle.addEventListener('change', () => this.toggleTheme());
                
                window.addEventListener('keydown', (e) => this.handleKeyDown(e));
                window.addEventListener('keyup', (e) => this.handleKeyUp(e));

                const container = this.dom.canvasContainer;
                container.addEventListener('pointerdown', (e) => { this.state.lastPointerEvent = e; });
                container.addEventListener('pointermove', this.debounce((e) => { this.state.lastPointerEvent = e; this.updateMagnifier(e); }, 10));
                container.addEventListener('click', (e) => this.handleCanvasClick(e));
                container.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: false });
                container.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
                container.addEventListener('touchend', (e) => this.handleTouchEnd(e));
                
                this.dom.imageCanvas.addEventListener('focus', () => this.dom.virtualCursor.style.display = 'block');
                this.dom.imageCanvas.addEventListener('blur', () => this.dom.virtualCursor.style.display = 'none');
                this.dom.imageCanvas.addEventListener('keydown', (e) => this.handleCanvasKeyboard(e));
                
                this.setupPaletteTabs();
            },
            
            // --- UPGRADE: All new/refactored functions ---
            
            resetState() {
                if (this.state.panzoomInstance) {
                    this.state.panzoomInstance.destroy();
                }
                Object.assign(this.state, this.getInitialState());
                this.dom.uploadArea.style.display = 'flex';
                this.dom.imageCanvas.style.display = 'none';
                this.dom.navigator.style.display = 'none';
                this.dom.closeImageBtn.style.display = 'none';
                this.dom.canvasContainer.classList.remove('image-loaded');
                this.dom.magnifierContainer.style.display = 'none';
                this.dom.resultsContainer.style.display = 'none';
                this.dom.resultsCard.classList.remove('visible');
                this.dom.uploadLabel.removeAttribute('disabled');
                this.dom.pixelGridCtx.clearRect(0, 0, this.dom.pixelGridCanvas.width, this.dom.pixelGridCanvas.height);
            },
            
            handleFiles(files) {
                // UPGRADE: Use main overlay loader
                this.dom.loaderContainer.style.display = 'flex';
                this.dom.uploadLabel.setAttribute('disabled', true);
                
                const file = files[0];
                if (!file || !file.type.startsWith('image/')) {
                    this.showToast('Please select a valid image file.', true);
                    this.dom.loaderContainer.style.display = 'none';
                    this.dom.uploadLabel.removeAttribute('disabled');
                    return;
                }
                
                this.resetState(); // Full state reset before loading new image

                this.resizeImage(file, (resizedBlob, resizedDataUrl) => {
                    // ... (image loading logic, but on error/success, hide main loader)
                    this.state.originalImage.onload = () => {
                        // ... setup canvas, panzoom ...
                        this.dom.loaderContainer.style.display = 'none'; // Hide loader on success
                    };
                    this.state.originalImage.onerror = () => {
                        this.dom.loaderContainer.style.display = 'none'; // Hide loader on error
                        // ...
                    };
                });
            },
            
            // UPGRADE: Use Blob and Object URL for more efficient resizing
            resizeImage(file, callback) {
                const reader = new FileReader();
                reader.onerror = () => callback(null, null);
                reader.onload = (e) => {
                    const img = new Image();
                    img.onerror = () => callback(null, null);
                    img.onload = () => {
                        let { width, height } = img;
                        const ratio = width / height;
                        if (width > this.CONSTANTS.MAX_IMAGE_DIMENSION) { width = this.CONSTANTS.MAX_IMAGE_DIMENSION; height = width / ratio; }
                        if (height > this.CONSTANTS.MAX_IMAGE_DIMENSION) { height = this.CONSTANTS.MAX_IMAGE_DIMENSION; width = height * ratio; }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob(blob => {
                            const dataUrl = URL.createObjectURL(blob);
                            callback(blob, dataUrl);
                        }, file.type, 0.9);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            },

            // ... (All other functions from previous implementation go here)
            // ... (Make sure to update DOM references from e.g. `this.zoomSlider` to `this.dom.zoomSliderPro`)
            
            clearHistory() {
                if (confirm("Are you sure you want to clear the entire history?")) {
                    this.state.colorHistory = [];
                    this.renderHistory();
                    this.showToast('History cleared.');
                }
            },
            
            renderHistory() {
                const list = this.dom.historyList;
                if (this.state.colorHistory.length === 0) {
                    this.dom.historyEmptyState.style.display = 'flex';
                    list.innerHTML = '';
                } else {
                    this.dom.historyEmptyState.style.display = 'none';
                    list.innerHTML = '';
                    this.state.colorHistory.forEach((color, index) => {
                        const li = document.createElement('li');
                        li.setAttribute('tabindex', '0'); // For focus
                        li.setAttribute('aria-label', `Color: ${color.color_name}, Hex: ${color.hex_code}`);
                        
                        li.innerHTML = `
                            <div class="history-swatch" style="background-color: ${color.detected_rgb};"></div>
                            <div class="history-info">
                                <strong>${color.color_name}</strong><br><span>${color.hex_code}</span>
                            </div>
                            <button class="delete-history-item" data-index="${index}" title="Delete color" aria-label="Delete ${color.color_name}">&times;</button>
                        `;
                        
                        li.onclick = (e) => {
                            if (e.target.classList.contains('delete-history-item')) return;
                            this.displayResults(color);
                        };
                        
                        // Add listener for Enter key on focused item
                        li.onkeydown = (e) => {
                            if (e.key === 'Enter') this.displayResults(color);
                        };

                        list.appendChild(li);
                    });
                    
                    // Add delegate event listener for delete buttons
                    list.querySelector('.delete-history-item').addEventListener('click', (e) => {
                        e.stopPropagation(); // prevent li click
                        const indexToDelete = parseInt(e.target.dataset.index, 10);
                        this.state.colorHistory.splice(indexToDelete, 1);
                        this.renderHistory();
                    });
                }
            },
            
            // ... and so on for every function, ensuring all state and DOM interactions are updated.
        };

        colorApp.init();

    </script>
</body>
</html>